<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Skywalking梳理 | JeckFS</title><meta name="keywords" content="微服务"><meta name="author" content="YFS"><meta name="copyright" content="YFS"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="参考博客 1. Skywalking 整体架构名次解释  服务( Service )：表示对请求提供相同行为的一系列或一组工作负载. 在使用打点代理或 SDK 的时候, 你可以定义服务的名字. 如果不定义的话, SkyWalking 将会使用你平台上定义的名字 服务实例( service instance )：上述的一组工作负载中的每一个工作负载称为一个实例. 就像 Kubernetes 中的 p">
<meta property="og:type" content="article">
<meta property="og:title" content="Skywalking梳理">
<meta property="og:url" content="http://jeckfs.gitee.io/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/index.html">
<meta property="og:site_name" content="JeckFS">
<meta property="og:description" content="参考博客 1. Skywalking 整体架构名次解释  服务( Service )：表示对请求提供相同行为的一系列或一组工作负载. 在使用打点代理或 SDK 的时候, 你可以定义服务的名字. 如果不定义的话, SkyWalking 将会使用你平台上定义的名字 服务实例( service instance )：上述的一组工作负载中的每一个工作负载称为一个实例. 就像 Kubernetes 中的 p">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img0.baidu.com/it/u=4226681601,4255880919&fm=253&fmt=auto&app=120&f=JPEG?w=641&h=361">
<meta property="article:published_time" content="2022-05-28T01:16:03.000Z">
<meta property="article:modified_time" content="2022-06-10T02:31:14.765Z">
<meta property="article:author" content="YFS">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img0.baidu.com/it/u=4226681601,4255880919&fm=253&fmt=auto&app=120&f=JPEG?w=641&h=361"><link rel="shortcut icon" href="/JeckFS/img/favicon.png"><link rel="canonical" href="http://jeckfs.gitee.io/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/JeckFS/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/JeckFS/',
  algolia: undefined,
  localSearch: {"path":"/JeckFS/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Skywalking梳理',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-10 10:31:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/JeckFS/archives/"><div class="headline">文章</div><div class="length-num">234</div></a><a href="/JeckFS/tags/"><div class="headline">标签</div><div class="length-num">67</div></a><a href="/JeckFS/categories/"><div class="headline">分类</div><div class="length-num">63</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img0.baidu.com/it/u=4226681601,4255880919&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=641&amp;h=361')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/JeckFS/">JeckFS</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Skywalking梳理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-28T01:16:03.000Z" title="发表于 2022-05-28 09:16:03">2022-05-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-06-10T02:31:14.765Z" title="更新于 2022-06-10 10:31:14">2022-06-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/JeckFS/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Skywalking梳理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39975683/article/details/111581308">参考博客</a></p>
<h1 id="1-Skywalking-整体架构"><a href="#1-Skywalking-整体架构" class="headerlink" title="1. Skywalking 整体架构"></a>1. Skywalking 整体架构</h1><p><strong>名次解释</strong></p>
<ul>
<li><strong>服务( Service )</strong>：表示对请求提供相同行为的一系列或一组工作负载. 在使用打点代理或 SDK 的时候, 你可以定义服务的名字. 如果不定义的话, SkyWalking 将会使用你平台上定义的名字</li>
<li><strong>服务实例( service instance )</strong>：上述的一组工作负载中的每一个工作负载称为一个实例. 就像 Kubernetes 中的 pods 一样, 服务实例未必就是操作系统上的一个进程. 但当你在使用打点代理的时候, 一个服务实例实际就是操作系统上的一个真实进程</li>
<li><strong>端点( Endpoint )</strong>：对于特定服务所接收的请求路径, 如 HTTP 的 URI 路径和 gRPC 服务的类名 + 方法签名.</li>
</ul>
<p><strong>架构</strong></p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-28_09-21-26.png" class="" title="This is 1-th image.">
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-28_09-23-13.png" class="" title="This is 1-th image.">
<p>所谓探针，指的是图中 Tracing 和 Metrics 部分。</p>
<ul>
<li>Agent / Probe 探针。主要收集应用的监控数据，包括调用关系、执行时间、是否报错、错误堆栈、 Service Mesh 中的探针。</li>
<li>后端服务（Backend / OAP Server）。收集并处理 agent 探针上报的监控数据，经过分析处理后持久化到存储模块</li>
<li>存储。用来持久化后端服务处理完成后到数据。如 Elasticsearch、 MySQL、TiDB等</li>
<li>UI 模块。用于前端查询各种监控数据并展现给用户。</li>
</ul>
<p><strong>限制</strong></p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-28_09-32-52.png" class="" title="This is 1-th image.">
<h2 id="1-1-探针"><a href="#1-1-探针" class="headerlink" title="1.1 探针"></a>1.1 探针</h2><p>Skywalking-agent 目录结构：</p>
<p>├── LICENSE<br>├── NOTICE<br>├── activations <strong>存放用于激活 Skywalking 的应用工具包的插件包</strong><br>│   ├── apm-toolkit-kafka-activation-8.10.0.jar<br>│   ├── apm-toolkit-log4j-1.x-activation-8.10.0.jar<br>│   ├── apm-toolkit-log4j-2.x-activation-8.10.0.jar<br>│   ├── apm-toolkit-logback-1.x-activation-8.10.0.jar<br>│   ├── apm-toolkit-logging-common-8.10.0.jar<br>│   ├── apm-toolkit-meter-activation-8.10.0.jar<br>│   ├── apm-toolkit-opentracing-activation-8.10.0.jar<br>│   └── apm-toolkit-trace-activation-8.10.0.jar<br>├── bootstrap-plugins<br>│   ├── apm-jdk-http-plugin-8.10.0.jar<br>│   ├── apm-jdk-threading-plugin-8.10.0.jar<br>│   └── apm-jdk-threadpool-plugin-8.10.0.jar<br>├── config<br>│   └── agent.config <strong>JavaAgent 的默认配置</strong><br>├── licenses<br>│   └── LICENSE-asm.txt<br>├── logs <strong>探针启动成功后，Skywalking 的日志会保存在此目录下</strong><br>├── optional-plugins <strong>Skywalking 可选的中间件、框架、库。将本文件夹下的 jar 包移动至 plugins 文件夹下才会起效</strong><br>│   ├── apm-customize-enhance-plugin-8.10.0.jar<br>│   ├── apm-ehcache-2.x-plugin-8.10.0.jar<br>│   ├── apm-fastjson-1.x-plugin-8.10.0.jar<br>│   ├── apm-gson-2.x-plugin-8.10.0.jar<br>│   ├── apm-guava-cache-plugin-8.10.0.jar<br>│   ├── apm-jackson-2.x-plugin-8.10.0.jar<br>│   ├── apm-kotlin-coroutine-plugin-8.10.0.jar<br>│   ├── apm-mybatis-3.x-plugin-8.10.0.jar<br>│   ├── apm-quartz-scheduler-2.x-plugin-8.10.0.jar<br>│   ├── apm-sentinel-1.x-plugin-8.10.0.jar<br>│   ├── apm-shenyu-2.4.x-plugin-8.10.0.jar<br>│   ├── apm-spring-annotation-plugin-8.10.0.jar<br>│   ├── apm-spring-cloud-gateway-2.0.x-plugin-8.10.0.jar<br>│   ├── apm-spring-cloud-gateway-2.1.x-plugin-8.10.0.jar<br>│   ├── apm-spring-cloud-gateway-3.x-plugin-8.10.0.jar<br>│   ├── apm-spring-tx-plugin-8.10.0.jar<br>│   ├── apm-spring-webflux-5.x-plugin-8.10.0.jar<br>│   ├── apm-trace-ignore-plugin-8.10.0.jar<br>│   └── apm-zookeeper-3.4.x-plugin-8.10.0.jar<br>├── optional-reporter-plugins<br>│   ├── kafka-reporter-plugin-8.10.0.jar<br>│   ├── lz4-java-1.6.0.jar<br>│   ├── snappy-java-1.1.7.3.jar<br>│   └── zstd-jni-1.4.3-1.jar<br>├── plugins <strong>Skywalking 支持的中间件、框架、库</strong><br>│   ├── apm-activemq-5.x-plugin-8.10.0.jar<br>│   ├── apm-armeria-0.84.x-plugin-8.10.0.jar<br>│   ├── apm-armeria-0.85.x-plugin-8.10.0.jar<br>│   ├── apm-asynchttpclient-2.x-plugin-8.10.0.jar<br>│   ├── apm-avro-plugin-8.10.0.jar<br>│   ├── apm-canal-1.x-plugin-8.10.0.jar<br>│   ├── apm-cassandra-java-driver-3.x-plugin-8.10.0.jar<br>│   ├── apm-clickhouse-0.3.x-plugin-8.10.0.jar<br>│   ├── apm-cxf-3.x-plugin-8.10.0.jar<br>│   ├── apm-dubbo-2.7.x-plugin-8.10.0.jar<br>│   ├── apm-dubbo-3.x-plugin-8.10.0.jar<br>│   ├── apm-dubbo-plugin-8.10.0.jar<br>│   ├── apm-elastic-job-2.x-plugin-8.10.0.jar<br>│   ├── apm-elasticjob-3.x-plugin-8.10.0.jar<br>│   ├── apm-elasticsearch-5.x-plugin-8.10.0.jar<br>│   ├── apm-elasticsearch-6.x-plugin-8.10.0.jar<br>│   ├── apm-elasticsearch-7.x-plugin-8.10.0.jar<br>│   ├── apm-feign-default-http-9.x-plugin-8.10.0.jar<br>│   ├── apm-finagle-6.25.x-plugin-8.10.0.jar<br>│   ├── apm-grpc-1.x-plugin-8.10.0.jar<br>│   ├── apm-guava-eventbus-plugin-8.10.0.jar<br>│   ├── apm-h2-1.x-plugin-8.10.0.jar<br>│   ├── apm-hbase-1.x-2.x-plugin-8.10.0.jar<br>│   ├── apm-hikaricp-3.x-4.x-plugin-8.10.0.jar<br>│   ├── apm-httpClient-4.x-plugin-8.10.0.jar<br>│   ├── apm-httpasyncclient-4.x-plugin-8.10.0.jar<br>│   ├── apm-httpclient-3.x-plugin-8.10.0.jar<br>│   ├── apm-httpclient-5.x-plugin-8.10.0.jar<br>│   ├── apm-httpclient-commons-8.10.0.jar<br>│   ├── apm-hystrix-1.x-plugin-8.10.0.jar<br>│   ├── apm-influxdb-2.x-plugin-8.10.0.jar<br>│   ├── apm-jdbc-commons-8.10.0.jar<br>│   ├── apm-jedis-2.x-plugin-8.10.0.jar<br>│   ├── apm-jetty-client-9.0-plugin-8.10.0.jar<br>│   ├── apm-jetty-client-9.x-plugin-8.10.0.jar<br>│   ├── apm-jetty-server-9.x-plugin-8.10.0.jar<br>│   ├── apm-kafka-commons-8.10.0.jar<br>│   ├── apm-kafka-plugin-8.10.0.jar<br>│   ├── apm-kylin-jdbc-2.6.x-3.x-4.x-plugin-8.10.0.jar<br>│   ├── apm-lettuce-5.x-plugin-8.10.0.jar<br>│   ├── apm-light4j-plugin-8.10.0.jar<br>│   ├── apm-mariadb-2.x-plugin-8.10.0.jar<br>│   ├── apm-mongodb-2.x-plugin-8.10.0.jar<br>│   ├── apm-mongodb-3.x-plugin-8.10.0.jar<br>│   ├── apm-mongodb-4.x-plugin-8.10.0.jar<br>│   ├── apm-mssql-commons-8.10.0.jar<br>│   ├── apm-mssql-jdbc-plugin-8.10.0.jar<br>│   ├── apm-mssql-jtds-1.x-plugin-8.10.0.jar<br>│   ├── apm-mysql-5.x-plugin-8.10.0.jar<br>│   ├── apm-mysql-6.x-plugin-8.10.0.jar<br>│   ├── apm-mysql-8.x-plugin-8.10.0.jar<br>│   ├── apm-mysql-commons-8.10.0.jar<br>│   ├── apm-neo4j-4.x-plugin-8.10.0.jar<br>│   ├── apm-netty-socketio-plugin-8.10.0.jar<br>│   ├── apm-nutz-http-1.x-plugin-8.10.0.jar<br>│   ├── apm-nutz-mvc-annotation-1.x-plugin-8.10.0.jar<br>│   ├── apm-okhttp-3.x-plugin-8.10.0.jar<br>│   ├── apm-okhttp-4.x-plugin-8.10.0.jar<br>│   ├── apm-okhttp-common-8.10.0.jar<br>│   ├── apm-play-2.x-plugin-8.10.0.jar<br>│   ├── apm-postgresql-8.x-plugin-8.10.0.jar<br>│   ├── apm-pulsar-2.2-2.7-plugin-8.10.0.jar<br>│   ├── apm-pulsar-2.8.x-plugin-8.10.0.jar<br>│   ├── apm-pulsar-common-8.10.0.jar<br>│   ├── apm-quasar-plugin-8.10.0.jar<br>│   ├── apm-rabbitmq-5.x-plugin-8.10.0.jar<br>│   ├── apm-redisson-3.x-plugin-8.10.0.jar<br>│   ├── apm-resttemplate-4.3.x-plugin-8.10.0.jar<br>│   ├── apm-rocketmq-3.x-plugin-8.10.0.jar<br>│   ├── apm-rocketmq-4.x-plugin-8.10.0.jar<br>│   ├── apm-servicecomb-java-chassis-1.x-plugin-8.10.0.jar<br>│   ├── apm-sharding-sphere-3.x-plugin-8.10.0.jar<br>│   ├── apm-sharding-sphere-4.1.0-plugin-8.10.0.jar<br>│   ├── apm-shardingsphere-4.0.x-plugin-8.10.0.jar<br>│   ├── apm-shardingsphere-5.0.0-plugin-8.10.0.jar<br>│   ├── apm-solrj-7.x-plugin-8.10.0.jar<br>│   ├── apm-spring-async-annotation-plugin-8.10.0.jar<br>│   ├── apm-spring-cloud-feign-1.x-plugin-8.10.0.jar<br>│   ├── apm-spring-cloud-feign-2.x-plugin-8.10.0.jar<br>│   ├── apm-spring-concurrent-util-4.x-plugin-8.10.0.jar<br>│   ├── apm-spring-core-patch-8.10.0.jar<br>│   ├── apm-spring-kafka-1.x-plugin-8.10.0.jar<br>│   ├── apm-spring-kafka-2.x-plugin-8.10.0.jar<br>│   ├── apm-spring-scheduled-annotation-plugin-8.10.0.jar<br>│   ├── apm-springmvc-annotation-3.x-plugin-8.10.0.jar<br>│   ├── apm-springmvc-annotation-4.x-plugin-8.10.0.jar<br>│   ├── apm-springmvc-annotation-5.x-plugin-8.10.0.jar<br>│   ├── apm-springmvc-annotation-commons-8.10.0.jar<br>│   ├── apm-spymemcached-2.x-plugin-8.10.0.jar<br>│   ├── apm-struts2-2.x-plugin-8.10.0.jar<br>│   ├── apm-tomcat-thread-pool-plugin-8.10.0.jar<br>│   ├── apm-undertow-2.x-plugin-8.10.0.jar<br>│   ├── apm-undertow-worker-thread-pool-plugin-8.10.0.jar<br>│   ├── apm-vertx-core-3.x-plugin-8.10.0.jar<br>│   ├── apm-vertx-core-4.x-plugin-8.10.0.jar<br>│   ├── apm-xmemcached-2.x-plugin-8.10.0.jar<br>│   ├── apm-xxl-job-2.x-plugin-8.10.0.jar<br>│   ├── baidu-brpc-plugin-8.10.0.jar<br>│   ├── dbcp-2.x-plugin-8.10.0.jar<br>│   ├── druid-1.x-plugin-8.10.0.jar<br>│   ├── dubbo-2.7.x-conflict-patch-8.10.0.jar<br>│   ├── dubbo-3.x-conflict-patch-8.10.0.jar<br>│   ├── dubbo-conflict-patch-8.10.0.jar<br>│   ├── graphql-12.x-15.x-plugin-8.10.0.jar<br>│   ├── graphql-16plus-plugin-8.10.0.jar<br>│   ├── graphql-8.x-plugin-8.10.0.jar<br>│   ├── graphql-9.x-plugin-8.10.0.jar<br>│   ├── jsonrpc4j-1.x-plugin-8.10.0.jar<br>│   ├── motan-plugin-8.10.0.jar<br>│   ├── okhttp-2.x-plugin-8.10.0.jar<br>│   ├── resteasy-server-3.x-plugin-8.10.0.jar<br>│   ├── sofa-rpc-plugin-8.10.0.jar<br>│   ├── spring-commons-8.10.0.jar<br>│   ├── spring-webflux-5.x-webclient-plugin-8.10.0.jar<br>│   ├── thrift-plugin-8.10.0.jar<br>│   └── tomcat-7.x-8.x-plugin-8.10.0.jar<br>└── skywalking-agent.jar <strong>Skywalking 的 JavaAgent 入口</strong></p>
<p><strong>Skywalking-Agent 配置参数：</strong></p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-28_10-08-20.png" class="" title="This is 1-th image.">
<p><code>agent.sample_n_per_3_secs=400</code>代表 Skywalking 只会采集 3 秒内的 400 个链路。</p>
<p><strong>agent.config 配置覆盖</strong></p>
<p>优先级：<br>探针参数 -&gt; 系统属性 -&gt; 系统环境变量 -&gt; 配置文件</p>
<ul>
<li>探针参数：<code>-javaagent:/path/to/skywalking-agent.jar=[option1]=[value],[option2]=[value]</code></li>
<li>系统属性：<code>-Dskywalking.agent.service_name=skywalking-demo</code> 覆盖 agent.config 中 agent.service_name 的配置。</li>
<li>系统环境变量：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">agent.config 文件</span></span><br><span class="line">agent.service_name=$&#123;SW_AGENT_NAME:Your_ApplicationName&#125;</span><br><span class="line">logging.level=$&#123;SW_LOGGING_LEVEL:INFO&#125;</span><br></pre></td></tr></table></figure>
linux：将变量 SW_AGENT_NAME 配置在 Path 环境变量中。</li>
</ul>
<p><strong>自定义配置文件</strong><br>应用场景：若干实例配置基本相同时才会使用同一份配置文件，当实例之间的配置大相径庭时就应该独立使用另一份儿配置文件。</p>
<p>通过 <code>-Dskywalking_config=/path/to/agent.config</code> 配置即可。</p>
<p>优先级：<br>指定的 agent 配置文件 -&gt; 默认 agent 配置文件</p>
<p><strong>TLS</strong></p>
<p>TLS（Transport Layer Security, 传输层安全性协议）会将应用层报文进行加密后再交由 TCP 进行传输。<br>应用场景：<br>当 Skywalking 后端和受监控的应用在不同的专有网络中时，需要通过 TLS 加密后再传输。</p>
<p>开启 TLS 的方法参见，书籍 P38 。</p>
<p><strong>命名空间</strong><br>应用场景：对于某些大型的系统可能包含了很多公司的服务，但这些服务公用一套链路追踪系统，这时候有必要将不同公司的系统追踪数据进行隔离。</p>
<p>配置：<code>agent.namesapces=default-namespace</code><br>每个命名空间仅能从该命名空间下获取监控指标，当两个应用使用不同的名称空间时，跨进程传播链会中断。</p>
<blockquote>
<p>Skywalking 的默认 Header 的 key 是 sw6 ，当设置 agent.namespaces 后 Header 的 key 就变为 namespaces + “-sw6” 。</p>
</blockquote>
<p><strong>Application Toolkit API</strong></p>
<ul>
<li>需要在 Java 程序中调用</li>
<li>功能：日志与 TraceId 的整合、自定义某个方法的 Trace 、修改某个 Span 的信息、跨线程的链路追踪等</li>
</ul>
<p><strong>OpenTracing API</strong></p>
<ul>
<li>需要在 Java 程序中调用</li>
<li>功能：手动构建分布式链路追踪的上下文</li>
</ul>
<p>参见书籍 P39 。</p>
<h2 id="1-2-Skywalking-后端-与-UI"><a href="#1-2-Skywalking-后端-与-UI" class="headerlink" title="1.2 Skywalking 后端 与 UI"></a>1.2 Skywalking 后端 与 UI</h2><p>Skywalking 后端二级目录：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line">├── LICENSE</span><br><span class="line">├── NOTICE</span><br><span class="line">├── README.txt</span><br><span class="line">├── bin **Skywalking 后端启动脚本和 UI 模块启动脚本**</span><br><span class="line">│   ├── oapService.bat</span><br><span class="line">│   ├── oapService.sh</span><br><span class="line">│   ├── oapServiceInit.bat</span><br><span class="line">│   ├── oapServiceInit.sh</span><br><span class="line">│   ├── oapServiceNoInit.bat</span><br><span class="line">│   ├── oapServiceNoInit.sh</span><br><span class="line">│   ├── startup.bat</span><br><span class="line">│   ├── startup.sh</span><br><span class="line">│   ├── webappService.bat</span><br><span class="line">│   └── webappService.sh</span><br><span class="line">├── config</span><br><span class="line">│   ├── alarm-settings.yml **报警配置文件**</span><br><span class="line">│   ├── application.yml **后端服务主配置文件，包括 datasource 配置等**</span><br><span class="line">│   ├── component-libraries.yml</span><br><span class="line">│   ├── endpoint-name-grouping.yml</span><br><span class="line">│   ├── envoy-metrics-rules</span><br><span class="line">│   ├── fetcher-prom-rules</span><br><span class="line">│   ├── gateways.yml</span><br><span class="line">│   ├── lal</span><br><span class="line">│   ├── log-mal-rules</span><br><span class="line">│   ├── log4j2.xml **日志配置文件**</span><br><span class="line">│   ├── metadata-service-mapping.yaml</span><br><span class="line">│   ├── meter-analyzer-config</span><br><span class="line">│   ├── oal</span><br><span class="line">│   ├── openapi-definitions</span><br><span class="line">│   ├── otel-oc-rules</span><br><span class="line">│   ├── service-apdex-threshold.yml</span><br><span class="line">│   ├── trace-sampling-policy-settings.yml</span><br><span class="line">│   ├── ui-initialized-templates</span><br><span class="line">│   └── zabbix-rules</span><br><span class="line">├── config-examples</span><br><span class="line">│   ├── alarm-settings.yml</span><br><span class="line">│   ├── lal.yaml</span><br><span class="line">│   └── log-mal.yaml</span><br><span class="line">├── licenses **项目许可文件，项目所依赖的第三方包的许可文件声明**</span><br><span class="line">│   ├── LICENSE-H2.txt</span><br><span class="line">│   ├── LICENSE-antlr4-runtime.txt</span><br><span class="line">│   ├── LICENSE-asm.txt</span><br><span class="line">│   ├── LICENSE-bcpkix-jdk15on.txt</span><br><span class="line">│   ├── LICENSE-bcprov-jdk15on.txt</span><br><span class="line">│   ├── LICENSE-checker-qual.txt</span><br><span class="line">│   ├── LICENSE-compiler.txt</span><br><span class="line">│   ├── LICENSE-consul-client.txt</span><br><span class="line">│   ├── LICENSE-error_prone_annotations.txt</span><br><span class="line">│   ├── LICENSE-graphql-java-tools.txt</span><br><span class="line">│   ├── LICENSE-graphql-java.txt</span><br><span class="line">│   ├── LICENSE-hppc.txt</span><br><span class="line">│   ├── LICENSE-httpcomponents.txt</span><br><span class="line">│   ├── LICENSE-influxdb-java.txt</span><br><span class="line">│   ├── LICENSE-instrumentation-api.txt</span><br><span class="line">│   ├── LICENSE-jersey.txt</span><br><span class="line">│   ├── LICENSE-jopt-simple.txt</span><br><span class="line">│   ├── LICENSE-logback.txt</span><br><span class="line">│   ├── LICENSE-okhttp.txt</span><br><span class="line">│   ├── LICENSE-postgresql.txt</span><br><span class="line">│   ├── LICENSE-proto-google-common-protos.txt</span><br><span class="line">│   ├── LICENSE-protobuf-java-util.txt</span><br><span class="line">│   ├── LICENSE-protobuf-java.txt</span><br><span class="line">│   ├── LICENSE-reactive-streams.txt</span><br><span class="line">│   ├── LICENSE-slf4j.txt</span><br><span class="line">│   ├── LICENSE-zstd-jni.txt</span><br><span class="line">│   └── ui-licenses</span><br><span class="line">├── oap-libs **后端模块运行所需要的 jar 包目录**</span><br><span class="line">│   ├── HdrHistogram-2.1.12.jar</span><br><span class="line">│   ├── HikariCP-3.1.0.jar</span><br><span class="line">│   ├── LatencyUtils-2.0.3.jar</span><br><span class="line">│   ├── agent-analyzer-9.0.0.jar</span><br><span class="line">│   ├── animal-sniffer-annotations-1.19.jar</span><br><span class="line">│   ├── annotations-13.0.jar</span><br><span class="line">│   ├── antlr4-runtime-4.9.2.jar</span><br><span class="line">│   ├── aopalliance-1.0.jar</span><br><span class="line">│   ├── apm-network-9.0.0.jar</span><br><span class="line">│   ├── apollo-client-1.8.0.jar</span><br><span class="line">│   ├── apollo-core-1.8.0.jar</span><br><span class="line">│   ├── armeria-1.14.1.jar</span><br><span class="line">│   ├── armeria-graphql-1.14.1.jar</span><br><span class="line">│   ├── armeria-graphql-protocol-1.14.1.jar</span><br><span class="line">│   ├── armeria-protobuf-1.14.1.jar</span><br><span class="line">│   ├── audience-annotations-0.5.0.jar</span><br><span class="line">│   ├── bcpkix-jdk15on-1.69.jar</span><br><span class="line">│   ├── bcprov-ext-jdk15on-1.69.jar</span><br><span class="line">│   ├── bcprov-jdk15on-1.69.jar</span><br><span class="line">│   ├── bcutil-jdk15on-1.69.jar</span><br><span class="line">│   ├── brotli4j-1.6.0.jar</span><br><span class="line">│   ├── checker-qual-3.12.0.jar</span><br><span class="line">│   ├── classmate-1.5.1.jar</span><br><span class="line">│   ├── client-java-14.0.0.jar</span><br><span class="line">│   ├── client-java-api-14.0.0.jar</span><br><span class="line">│   ├── client-java-proto-14.0.0.jar</span><br><span class="line">│   ├── cluster-consul-plugin-9.0.0.jar</span><br><span class="line">│   ├── cluster-etcd-plugin-9.0.0.jar</span><br><span class="line">│   ├── cluster-kubernetes-plugin-9.0.0.jar</span><br><span class="line">│   ├── cluster-nacos-plugin-9.0.0.jar</span><br><span class="line">│   ├── cluster-standalone-plugin-9.0.0.jar</span><br><span class="line">│   ├── cluster-zookeeper-plugin-9.0.0.jar</span><br><span class="line">│   ├── commons-beanutils-1.9.4.jar</span><br><span class="line">│   ├── commons-codec-1.11.jar</span><br><span class="line">│   ├── commons-collections4-4.4.jar</span><br><span class="line">│   ├── commons-compress-1.21.jar</span><br><span class="line">│   ├── commons-io-2.7.jar</span><br><span class="line">│   ├── commons-lang3-3.12.0.jar</span><br><span class="line">│   ├── commons-logging-1.2.jar</span><br><span class="line">│   ├── commons-text-1.4.jar</span><br><span class="line">│   ├── configuration-api-9.0.0.jar</span><br><span class="line">│   ├── configuration-apollo-9.0.0.jar</span><br><span class="line">│   ├── configuration-consul-9.0.0.jar</span><br><span class="line">│   ├── configuration-discovery-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── configuration-etcd-9.0.0.jar</span><br><span class="line">│   ├── configuration-k8s-configmap-9.0.0.jar</span><br><span class="line">│   ├── configuration-nacos-9.0.0.jar</span><br><span class="line">│   ├── configuration-zookeeper-9.0.0.jar</span><br><span class="line">│   ├── consul-client-1.4.2.jar</span><br><span class="line">│   ├── converter-jackson-2.5.0.jar</span><br><span class="line">│   ├── converter-moshi-2.5.0.jar</span><br><span class="line">│   ├── curator-client-4.3.0.jar</span><br><span class="line">│   ├── curator-framework-4.3.0.jar</span><br><span class="line">│   ├── curator-recipes-4.3.0.jar</span><br><span class="line">│   ├── curator-x-discovery-4.3.0.jar</span><br><span class="line">│   ├── envoy-metrics-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── error_prone_annotations-2.11.0.jar</span><br><span class="line">│   ├── event-analyzer-9.0.0.jar</span><br><span class="line">│   ├── exporter-9.0.0.jar</span><br><span class="line">│   ├── failsafe-2.3.4.jar</span><br><span class="line">│   ├── failureaccess-1.0.1.jar</span><br><span class="line">│   ├── flatbuffers-java-1.12.0.jar</span><br><span class="line">│   ├── freemarker-2.3.28.jar</span><br><span class="line">│   ├── graphql-java-17.3.jar</span><br><span class="line">│   ├── graphql-java-extended-scalars-17.0.jar</span><br><span class="line">│   ├── graphql-java-tools-12.0.2.jar</span><br><span class="line">│   ├── groovy-3.0.8.jar</span><br><span class="line">│   ├── grpc-api-1.43.2.jar</span><br><span class="line">│   ├── grpc-configuration-sync-9.0.0.jar</span><br><span class="line">│   ├── grpc-context-1.43.2.jar</span><br><span class="line">│   ├── grpc-core-1.43.2.jar</span><br><span class="line">│   ├── grpc-grpclb-1.43.2.jar</span><br><span class="line">│   ├── grpc-netty-1.43.2.jar</span><br><span class="line">│   ├── grpc-protobuf-1.43.2.jar</span><br><span class="line">│   ├── grpc-protobuf-lite-1.43.2.jar</span><br><span class="line">│   ├── grpc-stub-1.43.2.jar</span><br><span class="line">│   ├── gson-2.9.0.jar</span><br><span class="line">│   ├── gson-fire-1.8.5.jar</span><br><span class="line">│   ├── guava-31.1-jre.jar</span><br><span class="line">│   ├── guice-4.1.0.jar</span><br><span class="line">│   ├── h2-2.1.210.jar</span><br><span class="line">│   ├── httpasyncclient-4.1.3.jar</span><br><span class="line">│   ├── httpclient-4.5.13.jar</span><br><span class="line">│   ├── httpcore-4.4.13.jar</span><br><span class="line">│   ├── httpcore-nio-4.4.13.jar</span><br><span class="line">│   ├── influxdb-java-2.15.jar</span><br><span class="line">│   ├── iotdb-session-0.12.5.jar</span><br><span class="line">│   ├── iotdb-thrift-0.12.5.jar</span><br><span class="line">│   ├── j2objc-annotations-1.3.jar</span><br><span class="line">│   ├── jackson-annotations-2.13.2.jar</span><br><span class="line">│   ├── jackson-core-2.13.2.jar</span><br><span class="line">│   ├── jackson-databind-2.13.2.2.jar</span><br><span class="line">│   ├── jackson-datatype-guava-2.9.10.jar</span><br><span class="line">│   ├── jackson-datatype-jdk8-2.9.10.jar</span><br><span class="line">│   ├── jackson-module-afterburner-2.12.2.jar</span><br><span class="line">│   ├── jackson-module-kotlin-2.13.1.jar</span><br><span class="line">│   ├── java-dataloader-3.1.0.jar</span><br><span class="line">│   ├── javassist-3.25.0-GA.jar</span><br><span class="line">│   ├── javax.inject-1.jar</span><br><span class="line">│   ├── jcl-over-slf4j-1.7.30.jar</span><br><span class="line">│   ├── jetcd-common-0.5.3.jar</span><br><span class="line">│   ├── jetcd-core-0.5.3.jar</span><br><span class="line">│   ├── jetcd-resolver-0.5.3.jar</span><br><span class="line">│   ├── joda-time-2.10.5.jar</span><br><span class="line">│   ├── jose4j-0.7.9.jar</span><br><span class="line">│   ├── jsr305-3.0.2.jar</span><br><span class="line">│   ├── kafka-clients-2.4.1.jar</span><br><span class="line">│   ├── kafka-fetcher-plugin-9.0.0.jar</span><br><span class="line">│   ├── kotlin-reflect-1.5.0.jar</span><br><span class="line">│   ├── kotlin-stdlib-1.5.0.jar</span><br><span class="line">│   ├── kotlin-stdlib-common-1.5.0.jar</span><br><span class="line">│   ├── kotlin-stdlib-jdk7-1.5.0.jar</span><br><span class="line">│   ├── kotlin-stdlib-jdk8-1.5.0.jar</span><br><span class="line">│   ├── kotlinx-coroutines-core-1.5.0-native-mt.jar</span><br><span class="line">│   ├── kotlinx-coroutines-core-jvm-1.5.0-native-mt.jar</span><br><span class="line">│   ├── kotlinx-coroutines-jdk8-1.5.0-native-mt.jar</span><br><span class="line">│   ├── kotlinx-coroutines-reactive-1.5.0-native-mt.jar</span><br><span class="line">│   ├── library-client-9.0.0.jar</span><br><span class="line">│   ├── library-datacarrier-queue-9.0.0.jar</span><br><span class="line">│   ├── library-elasticsearch-client-9.0.0.jar</span><br><span class="line">│   ├── library-module-9.0.0.jar</span><br><span class="line">│   ├── library-server-9.0.0.jar</span><br><span class="line">│   ├── library-util-9.0.0.jar</span><br><span class="line">│   ├── libthrift-0.14.1.jar</span><br><span class="line">│   ├── listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar</span><br><span class="line">│   ├── log-analyzer-9.0.0.jar</span><br><span class="line">│   ├── log4j-api-2.17.1.jar</span><br><span class="line">│   ├── log4j-core-2.17.1.jar</span><br><span class="line">│   ├── log4j-over-slf4j-1.7.30.jar</span><br><span class="line">│   ├── log4j-slf4j-impl-2.17.1.jar</span><br><span class="line">│   ├── logging-interceptor-3.13.1.jar</span><br><span class="line">│   ├── lz4-java-1.6.0.jar</span><br><span class="line">│   ├── meter-analyzer-9.0.0.jar</span><br><span class="line">│   ├── micrometer-core-1.8.2.jar</span><br><span class="line">│   ├── moshi-1.5.0.jar</span><br><span class="line">│   ├── msgpack-core-0.8.16.jar</span><br><span class="line">│   ├── mvel2-2.4.8.Final.jar</span><br><span class="line">│   ├── nacos-api-1.4.2.jar</span><br><span class="line">│   ├── nacos-client-1.4.2.jar</span><br><span class="line">│   ├── nacos-common-1.4.2.jar</span><br><span class="line">│   ├── netty-buffer-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-codec-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-codec-dns-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-codec-haproxy-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-codec-http-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-codec-http2-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-codec-socks-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-common-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-handler-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-handler-proxy-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-resolver-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-resolver-dns-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-resolver-dns-native-macos-4.1.68.Final-osx-aarch_64.jar</span><br><span class="line">│   ├── netty-resolver-dns-native-macos-4.1.68.Final-osx-x86_64.jar</span><br><span class="line">│   ├── netty-tcnative-boringssl-static-2.0.43.Final.jar</span><br><span class="line">│   ├── netty-transport-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-transport-native-epoll-4.1.68.Final-linux-x86_64.jar</span><br><span class="line">│   ├── netty-transport-native-epoll-4.1.68.Final.jar</span><br><span class="line">│   ├── netty-transport-native-unix-common-4.1.68.Final-linux-x86_64.jar</span><br><span class="line">│   ├── netty-transport-native-unix-common-4.1.68.Final.jar</span><br><span class="line">│   ├── oal-grammar-9.0.0.jar</span><br><span class="line">│   ├── oal-rt-9.0.0.jar</span><br><span class="line">│   ├── okhttp-3.14.9.jar</span><br><span class="line">│   ├── okio-1.17.2.jar</span><br><span class="line">│   ├── otel-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── perfmark-api-0.23.0.jar</span><br><span class="line">│   ├── postgresql-42.3.3.jar</span><br><span class="line">│   ├── prometheus-fetcher-plugin-9.0.0.jar</span><br><span class="line">│   ├── proto-google-common-protos-2.0.1.jar</span><br><span class="line">│   ├── protobuf-java-3.19.4.jar</span><br><span class="line">│   ├── protobuf-java-util-3.19.4.jar</span><br><span class="line">│   ├── query-graphql-plugin-9.0.0.jar</span><br><span class="line">│   ├── reactive-streams-1.0.2.jar</span><br><span class="line">│   ├── receiver-proto-9.0.0.jar</span><br><span class="line">│   ├── retrofit-2.5.0.jar</span><br><span class="line">│   ├── server-alarm-plugin-9.0.0.jar</span><br><span class="line">│   ├── server-core-9.0.0.jar</span><br><span class="line">│   ├── server-health-checker-9.0.0.jar</span><br><span class="line">│   ├── server-starter-9.0.0.jar</span><br><span class="line">│   ├── service-rpc-0.12.5.jar</span><br><span class="line">│   ├── simpleclient-0.6.0.jar</span><br><span class="line">│   ├── simpleclient_common-0.6.0.jar</span><br><span class="line">│   ├── simpleclient_hotspot-0.6.0.jar</span><br><span class="line">│   ├── simpleclient_httpserver-0.12.0.jar</span><br><span class="line">│   ├── skywalking-browser-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-clr-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-ebpf-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-event-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-jvm-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-log-recevier-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-management-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-mesh-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-meter-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-profile-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-sharing-server-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-trace-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── skywalking-zabbix-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── slf4j-api-1.7.30.jar</span><br><span class="line">│   ├── snakeyaml-1.28.jar</span><br><span class="line">│   ├── snappy-java-1.1.7.3.jar</span><br><span class="line">│   ├── storage-elasticsearch-plugin-9.0.0.jar</span><br><span class="line">│   ├── storage-influxdb-plugin-9.0.0.jar</span><br><span class="line">│   ├── storage-iotdb-plugin-9.0.0.jar</span><br><span class="line">│   ├── storage-jdbc-hikaricp-plugin-9.0.0.jar</span><br><span class="line">│   ├── storage-tidb-plugin-9.0.0.jar</span><br><span class="line">│   ├── storage-zipkin-elasticsearch-plugin-9.0.0.jar</span><br><span class="line">│   ├── swagger-annotations-1.6.3.jar</span><br><span class="line">│   ├── telemetry-api-9.0.0.jar</span><br><span class="line">│   ├── telemetry-prometheus-9.0.0.jar</span><br><span class="line">│   ├── tool-profile-snapshot-bootstrap-9.0.0.jar</span><br><span class="line">│   ├── tool-profile-snapshot-server-mock-9.0.0.jar</span><br><span class="line">│   ├── tsfile-0.12.5.jar</span><br><span class="line">│   ├── vavr-0.10.3.jar</span><br><span class="line">│   ├── vavr-match-0.10.3.jar</span><br><span class="line">│   ├── zipkin-2.9.1.jar</span><br><span class="line">│   ├── zipkin-receiver-plugin-9.0.0.jar</span><br><span class="line">│   ├── zookeeper-3.5.7.jar</span><br><span class="line">│   ├── zookeeper-jute-3.5.7.jar</span><br><span class="line">│   └── zstd-jni-1.4.3-1.jar</span><br><span class="line">├── tools</span><br><span class="line">│   └── profile-exporter</span><br><span class="line">└── webapp **UI 部署的文件目录，包含 UI 部署的 jar 包和相关的配置文件 webapp.yaml**</span><br><span class="line">    ├── skywalking-webapp.jar</span><br><span class="line">    └── webapp.yml</span><br></pre></td></tr></table></figure></p>
<p><strong>Skywalking 后端 application.yaml 配置模块：</strong></p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-28_14-16-21.png" class="" title="This is 1-th image.">
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-28_14-16-44.png" class="" title="This is 1-th image.">
<p><strong>1. 核心模块配置：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">core:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_CORE:default&#125;</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="comment"># Mixed: Receive agent data, Level 1 aggregate, Level 2 aggregate</span></span><br><span class="line">    <span class="comment"># Receiver: Receive agent data, Level 1 aggregate</span></span><br><span class="line">    <span class="comment"># Aggregator: Level 2 aggregate</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">$&#123;SW_CORE_ROLE:Mixed&#125;</span> <span class="comment"># Mixed/Receiver/Aggregator</span></span><br><span class="line">    <span class="attr">restHost:</span> <span class="string">$&#123;SW_CORE_REST_HOST:0.0.0.0&#125;</span></span><br><span class="line">    <span class="attr">restPort:</span> <span class="string">$&#123;SW_CORE_REST_PORT:12800&#125;</span></span><br><span class="line">    <span class="attr">restContextPath:</span> <span class="string">$&#123;SW_CORE_REST_CONTEXT_PATH:/&#125;</span></span><br><span class="line">    <span class="attr">restMinThreads:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_MIN_THREADS:1&#125;</span></span><br><span class="line">    <span class="attr">restMaxThreads:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_MAX_THREADS:200&#125;</span></span><br><span class="line">    <span class="attr">restIdleTimeOut:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_IDLE_TIMEOUT:30000&#125;</span></span><br><span class="line">    <span class="attr">restAcceptQueueSize:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_QUEUE_SIZE:0&#125;</span></span><br><span class="line">    <span class="attr">httpMaxRequestHeaderSize:</span> <span class="string">$&#123;SW_CORE_HTTP_MAX_REQUEST_HEADER_SIZE:8192&#125;</span></span><br><span class="line">    <span class="attr">gRPCHost:</span> <span class="string">$&#123;SW_CORE_GRPC_HOST:0.0.0.0&#125;</span></span><br><span class="line">    <span class="attr">gRPCPort:</span> <span class="string">$&#123;SW_CORE_GRPC_PORT:11800&#125;</span></span><br><span class="line">    <span class="attr">maxConcurrentCallsPerConnection:</span> <span class="string">$&#123;SW_CORE_GRPC_MAX_CONCURRENT_CALL:0&#125;</span></span><br><span class="line">    <span class="attr">maxMessageSize:</span> <span class="string">$&#123;SW_CORE_GRPC_MAX_MESSAGE_SIZE:0&#125;</span></span><br><span class="line">    <span class="attr">gRPCThreadPoolQueueSize:</span> <span class="string">$&#123;SW_CORE_GRPC_POOL_QUEUE_SIZE:-1&#125;</span></span><br><span class="line">    <span class="attr">gRPCThreadPoolSize:</span> <span class="string">$&#123;SW_CORE_GRPC_THREAD_POOL_SIZE:-1&#125;</span></span><br><span class="line">    <span class="attr">gRPCSslEnabled:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_ENABLED:false&#125;</span></span><br><span class="line">    <span class="attr">gRPCSslKeyPath:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_KEY_PATH:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">gRPCSslCertChainPath:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_CERT_CHAIN_PATH:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">gRPCSslTrustedCAPath:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_TRUSTED_CA_PATH:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">downsampling:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Hour</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Day</span></span><br><span class="line">    <span class="comment"># Set a timeout on metrics data. After the timeout has expired, the metrics data will automatically be deleted.</span></span><br><span class="line">    <span class="attr">enableDataKeeperExecutor:</span> <span class="string">$&#123;SW_CORE_ENABLE_DATA_KEEPER_EXECUTOR:true&#125;</span> <span class="comment"># Turn it off then automatically metrics data delete will be close.</span></span><br><span class="line">    <span class="attr">dataKeeperExecutePeriod:</span> <span class="string">$&#123;SW_CORE_DATA_KEEPER_EXECUTE_PERIOD:5&#125;</span> <span class="comment"># How often the data keeper executor runs periodically, unit is minute</span></span><br><span class="line">    <span class="attr">recordDataTTL:</span> <span class="string">$&#123;SW_CORE_RECORD_DATA_TTL:3&#125;</span> <span class="comment"># Unit is day</span></span><br><span class="line">    <span class="attr">metricsDataTTL:</span> <span class="string">$&#123;SW_CORE_METRICS_DATA_TTL:7&#125;</span> <span class="comment"># Unit is day</span></span><br><span class="line">    <span class="comment"># The period of L1 aggregation flush to L2 aggregation. Unit is ms.</span></span><br><span class="line">    <span class="attr">l1FlushPeriod:</span> <span class="string">$&#123;SW_CORE_L1_AGGREGATION_FLUSH_PERIOD:500&#125;</span></span><br><span class="line">    <span class="comment"># The threshold of session time. Unit is ms. Default value is 70s.</span></span><br><span class="line">    <span class="attr">storageSessionTimeout:</span> <span class="string">$&#123;SW_CORE_STORAGE_SESSION_TIMEOUT:70000&#125;</span></span><br><span class="line">    <span class="comment"># The period of doing data persistence. Unit is second.Default value is 25s</span></span><br><span class="line">    <span class="attr">persistentPeriod:</span> <span class="string">$&#123;SW_CORE_PERSISTENT_PERIOD:25&#125;</span></span><br><span class="line">    <span class="comment"># Cache metrics data for 1 minute to reduce database queries, and if the OAP cluster changes within that minute,</span></span><br><span class="line">    <span class="comment"># the metrics may not be accurate within that minute.</span></span><br><span class="line">    <span class="attr">enableDatabaseSession:</span> <span class="string">$&#123;SW_CORE_ENABLE_DATABASE_SESSION:true&#125;</span></span><br><span class="line">    <span class="attr">topNReportPeriod:</span> <span class="string">$&#123;SW_CORE_TOPN_REPORT_PERIOD:10&#125;</span> <span class="comment"># top_n record worker report cycle, unit is minute</span></span><br><span class="line">    <span class="comment"># Extra model column are the column defined by in the codes, These columns of model are not required logically in aggregation or further query,</span></span><br><span class="line">    <span class="comment"># and it will cause more load for memory, network of OAP and storage.</span></span><br><span class="line">    <span class="comment"># But, being activated, user could see the name in the storage entities, which make users easier to use 3rd party tool, such as Kibana-&gt;ES, to query the data by themselves.</span></span><br><span class="line">    <span class="attr">activeExtraModelColumns:</span> <span class="string">$&#123;SW_CORE_ACTIVE_EXTRA_MODEL_COLUMNS:false&#125;</span></span><br><span class="line">    <span class="comment"># The max length of service + instance names should be less than 200</span></span><br><span class="line">    <span class="attr">serviceNameMaxLength:</span> <span class="string">$&#123;SW_SERVICE_NAME_MAX_LENGTH:70&#125;</span></span><br><span class="line">    <span class="attr">instanceNameMaxLength:</span> <span class="string">$&#123;SW_INSTANCE_NAME_MAX_LENGTH:70&#125;</span></span><br><span class="line">    <span class="comment"># The max length of service + endpoint names should be less than 240</span></span><br><span class="line">    <span class="attr">endpointNameMaxLength:</span> <span class="string">$&#123;SW_ENDPOINT_NAME_MAX_LENGTH:150&#125;</span></span><br><span class="line">    <span class="comment"># Define the set of span tag keys, which should be searchable through the GraphQL.</span></span><br><span class="line">    <span class="attr">searchableTracesTags:</span> <span class="string">$&#123;SW_SEARCHABLE_TAG_KEYS:http.method,status_code,db.type,db.instance,mq.queue,mq.topic,mq.broker&#125;</span></span><br><span class="line">    <span class="comment"># Define the set of log tag keys, which should be searchable through the GraphQL.</span></span><br><span class="line">    <span class="attr">searchableLogsTags:</span> <span class="string">$&#123;SW_SEARCHABLE_LOGS_TAG_KEYS:level&#125;</span></span><br><span class="line">    <span class="comment"># Define the set of alarm tag keys, which should be searchable through the GraphQL.</span></span><br><span class="line">    <span class="attr">searchableAlarmTags:</span> <span class="string">$&#123;SW_SEARCHABLE_ALARM_TAG_KEYS:level&#125;</span></span><br><span class="line">    <span class="comment"># The number of threads used to prepare metrics data to the storage.</span></span><br><span class="line">    <span class="attr">prepareThreads:</span> <span class="string">$&#123;SW_CORE_PREPARE_THREADS:2&#125;</span></span><br><span class="line">    <span class="comment"># Turn it on then automatically grouping endpoint by the given OpenAPI definitions.</span></span><br><span class="line">    <span class="attr">enableEndpointNameGroupingByOpenapi:</span> <span class="string">$&#123;SW_CORE_ENABLE_ENDPOINT_NAME_GROUPING_BY_OPAENAPI:true&#125;</span></span><br></pre></td></tr></table></figure>
<p>recordDataTTL ： Recored 记录的数据的有效时间。<br>metricsDataTTL : Metric 数据的有效期。</p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-30_16-41-09.png" class="" title="This is 1-th image.">
<p>核心配置主要包括：</p>
<ul>
<li>当前实力节点的角色（role）</li>
<li>地址和端口配置</li>
<li>metric 指标数据的分析唯独（downsampling）</li>
<li>数据有效期</li>
</ul>
<p>后端服务角色：</p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-30_15-44-12.png" class="" title="This is 1-th image.">
<p><strong>2. 集群模块配置</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_CLUSTER:standalone&#125;</span></span><br><span class="line">  <span class="attr">standalone:</span></span><br><span class="line">  <span class="comment"># Please check your ZooKeeper is 3.5+, However, it is also compatible with ZooKeeper 3.4.x. Replace the ZooKeeper 3.5+</span></span><br><span class="line">  <span class="comment"># library the oap-libs folder with your ZooKeeper 3.4.x library.</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">$&#123;SW_NAMESPACE:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="string">$&#123;SW_CLUSTER_ZK_HOST_PORT:localhost:2181&#125;</span></span><br><span class="line">    <span class="comment"># Retry Policy</span></span><br><span class="line">    <span class="attr">baseSleepTimeMs:</span> <span class="string">$&#123;SW_CLUSTER_ZK_SLEEP_TIME:1000&#125;</span> <span class="comment"># initial amount of time to wait between retries</span></span><br><span class="line">    <span class="attr">maxRetries:</span> <span class="string">$&#123;SW_CLUSTER_ZK_MAX_RETRIES:3&#125;</span> <span class="comment"># max number of times to retry</span></span><br><span class="line">    <span class="comment"># Enable ACL</span></span><br><span class="line">    <span class="attr">enableACL:</span> <span class="string">$&#123;SW_ZK_ENABLE_ACL:false&#125;</span> <span class="comment"># disable ACL in default</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">$&#123;SW_ZK_SCHEMA:digest&#125;</span> <span class="comment"># only support digest schema</span></span><br><span class="line">    <span class="attr">expression:</span> <span class="string">$&#123;SW_ZK_EXPRESSION:skywalking:skywalking&#125;</span></span><br><span class="line">    <span class="attr">internalComHost:</span> <span class="string">$&#123;SW_CLUSTER_INTERNAL_COM_HOST:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">internalComPort:</span> <span class="string">$&#123;SW_CLUSTER_INTERNAL_COM_PORT:-1&#125;</span></span><br><span class="line">  <span class="attr">kubernetes:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">$&#123;SW_CLUSTER_K8S_NAMESPACE:default&#125;</span></span><br><span class="line">    <span class="attr">labelSelector:</span> <span class="string">$&#123;SW_CLUSTER_K8S_LABEL:app=collector,release=skywalking&#125;</span></span><br><span class="line">    <span class="attr">uidEnvName:</span> <span class="string">$&#123;SW_CLUSTER_K8S_UID:SKYWALKING_COLLECTOR_UID&#125;</span></span><br><span class="line">  <span class="attr">consul:</span></span><br><span class="line">    <span class="attr">serviceName:</span> <span class="string">$&#123;SW_SERVICE_NAME:&quot;SkyWalking_OAP_Cluster&quot;&#125;</span></span><br><span class="line">    <span class="comment"># Consul cluster nodes, example: 10.0.0.1:8500,10.0.0.2:8500,10.0.0.3:8500</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="string">$&#123;SW_CLUSTER_CONSUL_HOST_PORT:localhost:8500&#125;</span></span><br><span class="line">    <span class="attr">aclToken:</span> <span class="string">$&#123;SW_CLUSTER_CONSUL_ACLTOKEN:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">internalComHost:</span> <span class="string">$&#123;SW_CLUSTER_INTERNAL_COM_HOST:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">internalComPort:</span> <span class="string">$&#123;SW_CLUSTER_INTERNAL_COM_PORT:-1&#125;</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="comment"># etcd cluster nodes, example: 10.0.0.1:2379,10.0.0.2:2379,10.0.0.3:2379</span></span><br><span class="line">    <span class="attr">endpoints:</span> <span class="string">$&#123;SW_CLUSTER_ETCD_ENDPOINTS:localhost:2379&#125;</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">$&#123;SW_CLUSTER_ETCD_NAMESPACE:/skywalking&#125;</span></span><br><span class="line">    <span class="attr">serviceName:</span> <span class="string">$&#123;SW_CLUSTER_ETCD_SERVICE_NAME:&quot;SkyWalking_OAP_Cluster&quot;&#125;</span></span><br><span class="line">    <span class="attr">authentication:</span> <span class="string">$&#123;SW_CLUSTER_ETCD_AUTHENTICATION:false&#125;</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;SW_CLUSTER_ETCD_USER:&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;SW_CLUSTER_ETCD_PASSWORD:&#125;</span></span><br><span class="line">    <span class="attr">internalComHost:</span> <span class="string">$&#123;SW_CLUSTER_INTERNAL_COM_HOST:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">internalComPort:</span> <span class="string">$&#123;SW_CLUSTER_INTERNAL_COM_PORT:-1&#125;</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">serviceName:</span> <span class="string">$&#123;SW_SERVICE_NAME:&quot;SkyWalking_OAP_Cluster&quot;&#125;</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_HOST_PORT:localhost:8848&#125;</span></span><br><span class="line">    <span class="comment"># Nacos Configuration namespace</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_NAMESPACE:&quot;public&quot;&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth username</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_USERNAME:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_PASSWORD:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth accessKey</span></span><br><span class="line">    <span class="attr">accessKey:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_ACCESSKEY:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">secretKey:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_SECRETKEY:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">internalComHost:</span> <span class="string">$&#123;SW_CLUSTER_INTERNAL_COM_HOST:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">internalComPort:</span> <span class="string">$&#123;SW_CLUSTER_INTERNAL_COM_PORT:-1&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>存储模块配置</strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_STORAGE:h2&#125;</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">$&#123;SW_NAMESPACE:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">clusterNodes:</span> <span class="string">$&#123;SW_STORAGE_ES_CLUSTER_NODES:localhost:9200&#125;</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">$&#123;SW_STORAGE_ES_HTTP_PROTOCOL:&quot;http&quot;&#125;</span></span><br><span class="line">    <span class="attr">connectTimeout:</span> <span class="string">$&#123;SW_STORAGE_ES_CONNECT_TIMEOUT:3000&#125;</span></span><br><span class="line">    <span class="attr">socketTimeout:</span> <span class="string">$&#123;SW_STORAGE_ES_SOCKET_TIMEOUT:30000&#125;</span></span><br><span class="line">    <span class="attr">responseTimeout:</span> <span class="string">$&#123;SW_STORAGE_ES_RESPONSE_TIMEOUT:15000&#125;</span></span><br><span class="line">    <span class="attr">numHttpClientThread:</span> <span class="string">$&#123;SW_STORAGE_ES_NUM_HTTP_CLIENT_THREAD:0&#125;</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;SW_ES_USER:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;SW_ES_PASSWORD:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">trustStorePath:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PATH:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">trustStorePass:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PASS:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">secretsManagementFile:</span> <span class="string">$&#123;SW_ES_SECRETS_MANAGEMENT_FILE:&quot;&quot;&#125;</span> <span class="comment"># Secrets management file in the properties format includes the username, password, which are managed by 3rd party tool.</span></span><br><span class="line">    <span class="attr">dayStep:</span> <span class="string">$&#123;SW_STORAGE_DAY_STEP:1&#125;</span> <span class="comment"># Represent the number of days in the one minute/hour/day index.</span></span><br><span class="line">    <span class="attr">indexShardsNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_SHARDS_NUMBER:1&#125;</span> <span class="comment"># Shard number of new indexes</span></span><br><span class="line">    <span class="attr">indexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:1&#125;</span> <span class="comment"># Replicas number of new indexes</span></span><br><span class="line">    <span class="comment"># Super data set has been defined in the codes, such as trace segments.The following 3 config would be improve es performance when storage super size data in es.</span></span><br><span class="line">    <span class="attr">superDatasetDayStep:</span> <span class="string">$&#123;SW_SUPERDATASET_STORAGE_DAY_STEP:-1&#125;</span> <span class="comment"># Represent the number of days in the super size dataset record index, the default value is the same as dayStep when the value is less than 0</span></span><br><span class="line">    <span class="attr">superDatasetIndexShardsFactor:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR:5&#125;</span> <span class="comment">#  This factor provides more shards for the super data set, shards number = indexShardsNumber * superDatasetIndexShardsFactor. Also, this factor effects Zipkin and Jaeger traces.</span></span><br><span class="line">    <span class="attr">superDatasetIndexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_REPLICAS_NUMBER:0&#125;</span> <span class="comment"># Represent the replicas number in the super size dataset record index, the default value is 0.</span></span><br><span class="line">    <span class="attr">indexTemplateOrder:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_TEMPLATE_ORDER:0&#125;</span> <span class="comment"># the order of index template</span></span><br><span class="line">    <span class="attr">bulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_BULK_ACTIONS:5000&#125;</span> <span class="comment"># Execute the async bulk record data every $&#123;SW_STORAGE_ES_BULK_ACTIONS&#125; requests</span></span><br><span class="line">    <span class="comment"># flush the bulk every 10 seconds whatever the number of requests</span></span><br><span class="line">    <span class="comment"># INT(flushInterval * 2/3) would be used for index refresh period.</span></span><br><span class="line">    <span class="attr">flushInterval:</span> <span class="string">$&#123;SW_STORAGE_ES_FLUSH_INTERVAL:15&#125;</span></span><br><span class="line">    <span class="attr">concurrentRequests:</span> <span class="string">$&#123;SW_STORAGE_ES_CONCURRENT_REQUESTS:2&#125;</span> <span class="comment"># the number of concurrent requests</span></span><br><span class="line">    <span class="attr">resultWindowMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_SIZE:10000&#125;</span></span><br><span class="line">    <span class="attr">scrollingBatchSize:</span> <span class="string">$&#123;SW_STORAGE_ES_SCROLLING_BATCH_SIZE:5000&#125;</span></span><br><span class="line">    <span class="attr">segmentQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200&#125;</span></span><br><span class="line">    <span class="attr">profileTaskQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200&#125;</span></span><br><span class="line">    <span class="attr">oapAnalyzer:</span> <span class="string">$&#123;SW_STORAGE_ES_OAP_ANALYZER:&quot;&#123;\&quot;analyzer\&quot;:&#123;\&quot;oap_analyzer\&quot;:&#123;\&quot;type\&quot;:\&quot;stop\&quot;&#125;&#125;&#125;&quot;&#125;</span> <span class="comment"># the oap analyzer.</span></span><br><span class="line">    <span class="attr">oapLogAnalyzer:</span> <span class="string">$&#123;SW_STORAGE_ES_OAP_LOG_ANALYZER:&quot;&#123;\&quot;analyzer\&quot;:&#123;\&quot;oap_log_analyzer\&quot;:&#123;\&quot;type\&quot;:\&quot;standard\&quot;&#125;&#125;&#125;&quot;&#125;</span> <span class="comment"># the oap log analyzer. It could be customized by the ES analyzer configuration to support more language log formats, such as Chinese log, Japanese log and etc.</span></span><br><span class="line">    <span class="attr">advanced:</span> <span class="string">$&#123;SW_STORAGE_ES_ADVANCED:&quot;&quot;&#125;</span></span><br><span class="line">  <span class="attr">h2:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">$&#123;SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource&#125;</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">$&#123;SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db;DB_CLOSE_DELAY=-1&#125;</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;SW_STORAGE_H2_USER:sa&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_H2_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line">    <span class="attr">maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line">    <span class="attr">numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line">    <span class="attr">maxSizeOfBatchSql:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_BATCH_SQL:100&#125;</span></span><br><span class="line">    <span class="attr">asyncBatchPersistentPoolSize:</span> <span class="string">$&#123;SW_STORAGE_ASYNC_BATCH_PERSISTENT_POOL_SIZE:1&#125;</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:&quot;jdbc:mysql://localhost:3306/swtest?rewriteBatchedStatements=true&quot;&#125;</span></span><br><span class="line">      <span class="attr">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:root&#125;</span></span><br><span class="line">      <span class="attr">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:root@1234&#125;</span></span><br><span class="line">      <span class="attr">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="attr">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line">    <span class="attr">maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line">    <span class="attr">numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line">    <span class="attr">maxSizeOfBatchSql:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_BATCH_SQL:2000&#125;</span></span><br><span class="line">    <span class="attr">asyncBatchPersistentPoolSize:</span> <span class="string">$&#123;SW_STORAGE_ASYNC_BATCH_PERSISTENT_POOL_SIZE:4&#125;</span></span><br><span class="line">  <span class="attr">tidb:</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:&quot;jdbc:mysql://localhost:4000/tidbswtest?rewriteBatchedStatements=true&quot;&#125;</span></span><br><span class="line">      <span class="attr">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:root&#125;</span></span><br><span class="line">      <span class="attr">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:&quot;&quot;&#125;</span></span><br><span class="line">      <span class="attr">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="attr">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="attr">dataSource.useAffectedRows:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_AFFECTED_ROWS:true&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line">    <span class="attr">maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line">    <span class="attr">numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line">    <span class="attr">maxSizeOfBatchSql:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_BATCH_SQL:2000&#125;</span></span><br><span class="line">    <span class="attr">asyncBatchPersistentPoolSize:</span> <span class="string">$&#123;SW_STORAGE_ASYNC_BATCH_PERSISTENT_POOL_SIZE:4&#125;</span></span><br><span class="line">  <span class="attr">influxdb:</span></span><br><span class="line">    <span class="comment"># InfluxDB configuration</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_URL:http://localhost:8086&#125;</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_USER:root&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_PASSWORD:&#125;</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_DATABASE:skywalking&#125;</span></span><br><span class="line">    <span class="attr">actions:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_ACTIONS:1000&#125;</span> <span class="comment"># the number of actions to collect</span></span><br><span class="line">    <span class="attr">duration:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_DURATION:1000&#125;</span> <span class="comment"># the time to wait at most (milliseconds)</span></span><br><span class="line">    <span class="attr">batchEnabled:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_BATCH_ENABLED:true&#125;</span></span><br><span class="line">    <span class="attr">fetchTaskLogMaxSize:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_FETCH_TASK_LOG_MAX_SIZE:5000&#125;</span> <span class="comment"># the max number of fetch task log in a request</span></span><br><span class="line">    <span class="attr">connectionResponseFormat:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_CONNECTION_RESPONSE_FORMAT:MSGPACK&#125;</span> <span class="comment"># the response format of connection to influxDB, cannot be anything but MSGPACK or JSON.</span></span><br><span class="line">  <span class="attr">postgresql:</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:&quot;jdbc:postgresql://localhost:5432/skywalking&quot;&#125;</span></span><br><span class="line">      <span class="attr">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:postgres&#125;</span></span><br><span class="line">      <span class="attr">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:123456&#125;</span></span><br><span class="line">      <span class="attr">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="attr">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line">    <span class="attr">maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line">    <span class="attr">numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line">    <span class="attr">maxSizeOfBatchSql:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_BATCH_SQL:2000&#125;</span></span><br><span class="line">    <span class="attr">asyncBatchPersistentPoolSize:</span> <span class="string">$&#123;SW_STORAGE_ASYNC_BATCH_PERSISTENT_POOL_SIZE:4&#125;</span></span><br><span class="line">  <span class="attr">zipkin-elasticsearch:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">$&#123;SW_NAMESPACE:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">clusterNodes:</span> <span class="string">$&#123;SW_STORAGE_ES_CLUSTER_NODES:localhost:9200&#125;</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">$&#123;SW_STORAGE_ES_HTTP_PROTOCOL:&quot;http&quot;&#125;</span></span><br><span class="line">    <span class="attr">trustStorePath:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PATH:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">trustStorePass:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PASS:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">dayStep:</span> <span class="string">$&#123;SW_STORAGE_DAY_STEP:1&#125;</span> <span class="comment"># Represent the number of days in the one minute/hour/day index.</span></span><br><span class="line">    <span class="attr">indexShardsNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_SHARDS_NUMBER:1&#125;</span> <span class="comment"># Shard number of new indexes</span></span><br><span class="line">    <span class="attr">indexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:1&#125;</span> <span class="comment"># Replicas number of new indexes</span></span><br><span class="line">    <span class="comment"># Super data set has been defined in the codes, such as trace segments.The following 3 config would be improve es performance when storage super size data in es.</span></span><br><span class="line">    <span class="attr">superDatasetDayStep:</span> <span class="string">$&#123;SW_SUPERDATASET_STORAGE_DAY_STEP:-1&#125;</span> <span class="comment"># Represent the number of days in the super size dataset record index, the default value is the same as dayStep when the value is less than 0</span></span><br><span class="line">    <span class="attr">superDatasetIndexShardsFactor:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR:5&#125;</span> <span class="comment">#  This factor provides more shards for the super data set, shards number = indexShardsNumber * superDatasetIndexShardsFactor. Also, this factor effects Zipkin and Jaeger traces.</span></span><br><span class="line">    <span class="attr">superDatasetIndexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_REPLICAS_NUMBER:0&#125;</span> <span class="comment"># Represent the replicas number in the super size dataset record index, the default value is 0.</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;SW_ES_USER:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;SW_ES_PASSWORD:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">secretsManagementFile:</span> <span class="string">$&#123;SW_ES_SECRETS_MANAGEMENT_FILE:&quot;&quot;&#125;</span> <span class="comment"># Secrets management file in the properties format includes the username, password, which are managed by 3rd party tool.</span></span><br><span class="line">    <span class="attr">bulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_BULK_ACTIONS:5000&#125;</span> <span class="comment"># Execute the async bulk record data every $&#123;SW_STORAGE_ES_BULK_ACTIONS&#125; requests</span></span><br><span class="line">    <span class="comment"># flush the bulk every 10 seconds whatever the number of requests</span></span><br><span class="line">    <span class="comment"># INT(flushInterval * 2/3) would be used for index refresh period.</span></span><br><span class="line">    <span class="attr">flushInterval:</span> <span class="string">$&#123;SW_STORAGE_ES_FLUSH_INTERVAL:15&#125;</span></span><br><span class="line">    <span class="attr">concurrentRequests:</span> <span class="string">$&#123;SW_STORAGE_ES_CONCURRENT_REQUESTS:2&#125;</span> <span class="comment"># the number of concurrent requests</span></span><br><span class="line">    <span class="attr">resultWindowMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line">    <span class="attr">segmentQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200&#125;</span></span><br><span class="line">    <span class="attr">profileTaskQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200&#125;</span></span><br><span class="line">    <span class="attr">oapAnalyzer:</span> <span class="string">$&#123;SW_STORAGE_ES_OAP_ANALYZER:&quot;&#123;\&quot;analyzer\&quot;:&#123;\&quot;oap_analyzer\&quot;:&#123;\&quot;type\&quot;:\&quot;stop\&quot;&#125;&#125;&#125;&quot;&#125;</span> <span class="comment"># the oap analyzer.</span></span><br><span class="line">    <span class="attr">oapLogAnalyzer:</span> <span class="string">$&#123;SW_STORAGE_ES_OAP_LOG_ANALYZER:&quot;&#123;\&quot;analyzer\&quot;:&#123;\&quot;oap_log_analyzer\&quot;:&#123;\&quot;type\&quot;:\&quot;standard\&quot;&#125;&#125;&#125;&quot;&#125;</span> <span class="comment"># the oap log analyzer. It could be customized by the ES analyzer configuration to support more language log formats, such as Chinese log, Japanese log and etc.</span></span><br><span class="line">    <span class="attr">advanced:</span> <span class="string">$&#123;SW_STORAGE_ES_ADVANCED:&quot;&quot;&#125;</span></span><br><span class="line">  <span class="attr">iotdb:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">$&#123;SW_STORAGE_IOTDB_HOST:127.0.0.1&#125;</span></span><br><span class="line">    <span class="attr">rpcPort:</span> <span class="string">$&#123;SW_STORAGE_IOTDB_RPC_PORT:6667&#125;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;SW_STORAGE_IOTDB_USERNAME:root&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;SW_STORAGE_IOTDB_PASSWORD:root&#125;</span></span><br><span class="line">    <span class="attr">storageGroup:</span> <span class="string">$&#123;SW_STORAGE_IOTDB_STORAGE_GROUP:root.skywalking&#125;</span></span><br><span class="line">    <span class="attr">sessionPoolSize:</span> <span class="string">$&#123;SW_STORAGE_IOTDB_SESSIONPOOL_SIZE:8&#125;</span> <span class="comment"># If it&#x27;s zero, the SessionPool size will be 2*CPU_Cores</span></span><br><span class="line">    <span class="attr">fetchTaskLogMaxSize:</span> <span class="string">$&#123;SW_STORAGE_IOTDB_FETCH_TASK_LOG_MAX_SIZE:1000&#125;</span> <span class="comment"># the max number of fetch task log in a request</span></span><br></pre></td></tr></table></figure></p>
<p><strong>3. 查询模块配置</strong></p>
<p>查询模块通过 GraphQL 框架处理 API 请求，请求会发到核心模块配置的 restHost 和 restPort 中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">query:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_QUERY:graphql&#125;</span></span><br><span class="line">  <span class="attr">graphql:</span></span><br><span class="line">    <span class="comment"># Enable the log testing API to test the LAL.</span></span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> This API evaluates untrusted code on the OAP server.</span></span><br><span class="line">    <span class="comment"># A malicious script can do significant damage (steal keys and secrets, remove files and directories, install malware, etc).</span></span><br><span class="line">    <span class="comment"># As such, please enable this API only when you completely trust your users.</span></span><br><span class="line">    <span class="attr">enableLogTestTool:</span> <span class="string">$&#123;SW_QUERY_GRAPHQL_ENABLE_LOG_TEST_TOOL:false&#125;</span></span><br><span class="line">    <span class="comment"># Maximum complexity allowed for the GraphQL query that can be used to</span></span><br><span class="line">    <span class="comment"># abort a query if the total number of data fields queried exceeds the defined threshold.</span></span><br><span class="line">    <span class="attr">maxQueryComplexity:</span> <span class="string">$&#123;SW_QUERY_MAX_QUERY_COMPLEXITY:100&#125;</span></span><br><span class="line">    <span class="comment"># Allow user add, disable and update UI template</span></span><br><span class="line">    <span class="attr">enableUpdateUITemplate:</span> <span class="string">$&#123;SW_ENABLE_UPDATE_UI_TEMPLATE:false&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>4. 探针与集群通信</strong><br>OAP 服务端提供了 gRPC 和 HTTP RESTful 接口的方式接口客户端的数据。对于不同类型的数据 OAP 提供了不同的配置：</p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-30_16-29-09.png" class="" title="This is 1-th image.">
<p><strong>5. 设置服务端采样率：</strong></p>
<p>在服务端设置采样率只会将部分 trace 调用链路数据丢弃，不会影响 Metric 数据（比如 Service 、 service instance、endpoint）统计的准确性。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receiver-trace:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_RECEIVER_TRACE:default&#125;</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">sampleRate:</span> <span class="string">$&#123;SW_TRACE_SAMPLE_TATE:10000&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>6. 告警设置：</strong><br>告警的配置文件在 <code>apache-skywalking-apm-bin/config/alarm-settings.yml</code> 下，</p>
<p>该配置主要包含两部分：</p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-30_17-24-32.png" class="" title="This is 1-th image.">
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Rule unique name, must be ended with `_rule`.</span></span><br><span class="line">  <span class="attr">service_resp_time_rule:</span></span><br><span class="line">    <span class="attr">metrics-name:</span> <span class="string">service_resp_time</span></span><br><span class="line">    <span class="attr">op:</span> <span class="string">&quot;&gt;&quot;</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">period:</span> <span class="number">10</span> <span class="comment"># 时间窗口</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">3</span>   <span class="comment"># 时间窗口内，如果触发告警的次数达到配置的次数，将会告警</span></span><br><span class="line">    <span class="attr">silence-period:</span> <span class="number">5</span> <span class="comment"># 告警间隔时间，防止段时间内多次告警</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Response</span> <span class="string">time</span> <span class="string">of</span> <span class="string">service</span> &#123;<span class="string">name</span>&#125; <span class="string">is</span> <span class="string">more</span> <span class="string">than</span> <span class="string">1000ms</span> <span class="string">in</span> <span class="number">3</span> <span class="string">minutes</span> <span class="string">of</span> <span class="string">last</span> <span class="number">10</span> <span class="string">minutes.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="comment">#  - http://127.0.0.1/notify/</span></span><br><span class="line"><span class="comment">#  - http://127.0.0.1/go-wechat/</span></span><br></pre></td></tr></table></figure>
<p><strong>7. Exporter 设置</strong><br>用于转发采集的数据或处理过后的指标数据等。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">exporter:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_EXPORTER:-&#125;</span></span><br><span class="line">  <span class="attr">grpc:</span></span><br><span class="line">    <span class="comment"># 用于接收 Metrics 数据的服务地址</span></span><br><span class="line">    <span class="attr">targetHost:</span> <span class="string">$&#123;SW_EXPORTER_GRPC_HOST:127.0.0.1&#125;</span></span><br><span class="line">    <span class="comment"># 用于接收 Metrics 数据的端口</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">$&#123;SW_EXPORTER_GRPC_PORT:9870&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>UI 部署</strong></p>
<p>所有查询都是通过 Zuul 代理转发到 OAP 服务的 REST 服务端口，再通过 GraphQL 进行查询。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">oap-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://oap-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/graphql/**</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">simple:</span></span><br><span class="line">          <span class="attr">instances:</span></span><br><span class="line">            <span class="attr">oap-service:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">uri:</span> <span class="string">http://127.0.0.1:12800</span></span><br><span class="line">            <span class="comment"># - uri: http://&lt;oap-host-1&gt;:&lt;oap-port1&gt;</span></span><br><span class="line">            <span class="comment"># - uri: http://&lt;oap-host-2&gt;:&lt;oap-port2&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">throw-exception-if-no-handler-found:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">add-mappings:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">base-path:</span> <span class="string">/manage</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="2-轻量级队列内核"><a href="#2-轻量级队列内核" class="headerlink" title="2.轻量级队列内核"></a>2.轻量级队列内核</h1><img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-05-31_20-18-48.png" class="" title="This is 1-th image.">
<ul>
<li>数据结构<ul>
<li><code>Buffer</code> ： 数据的实际存放地<ul>
<li><code>Object[] buffer</code> ： 用于存储数据的队列。长度固定，</li>
<li><code>AtomicRangeInteger index</code> ： 一个原子循环索引，与 buffer 数组一起实现一个循环队列、</li>
<li><code>BufferStrategy strategy</code> ：队列策略。当数据生产者向 Buffer 的某个索引中存储数据时，发现该索引还存有旧数据没有消费完时的解决策略。</li>
<li><code>List&lt;QuueueBlockingCallback&lt;T&gt;&gt; callbacks</code> ： 数据阻塞时的回调函数。该回调仅在 BufferStrategy.BLOCKING 策略下起作用。</li>
</ul>
</li>
<li><code>Channel</code> ： 管理 Buffer 的载体<ul>
<li><code>Buffer&lt;T&gt;[] bufferChannels</code> ： 一个 Buffer 数组</li>
<li><code>IDataPartitioner&lt;T&gt; dataPartitioner</code> ： 当数据写入 Channel 时，dataPartitioner 决定将数据存储在哪个 Buffer 中，以及存储数据失败时的重试次数。</li>
<li><code>long size</code> ： Channel 能够容纳数据的大小，值为 Channel 中 Buffer 的数量乘以内部 Buffer 数组的长度。</li>
</ul>
</li>
<li><code>DataCarrier</code> ： 队列内核与其他模块交互的媒介，其在初始化时需要 CHANNEL_SIZE （当前 Channel 中有多少个 Buffer 队列）, BUFFER_SIZE （每个 Buffer 队列的大小）两个参数。</li>
</ul>
</li>
<li>生产消息<ul>
<li>数据分发 <code>IDataPartitioner</code> ： 默认实现为从第一个 Buffer 到最有一个 Buffer 无限循环选择。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IDataPartitioner</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">partition</span><span class="params">(<span class="type">int</span> total, T data)</span>; <span class="comment">// 决定当前数据应存储在哪个 Buffer 中，total 为 Buffer 队列的个数，data 为生产的数据，返回值为具体 Buffer 的索引值。</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">maxRetryCount</span><span class="params">()</span>; <span class="comment">// 重试次数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>数据的存储策略<ul>
<li>BLOCKING ： 循环阻塞，等待当前 Buffer 队列中的 index 空间为空，阻塞过程中会回调 Buffer 的回调方法。</li>
<li>OVERRIDE ： 新数据覆盖旧数据</li>
<li>IF_POSSIBLE ： 从当前 index 起往后找 n 位，若空余则存下来，否则丢弃掉。重试次数通过 IDataPartitioner 的 maxRetryCount 控制。</li>
</ul>
</li>
</ul>
</li>
<li>消费消息<ul>
<li>队列为无锁队列却能保证线程安全的原因：每个 buffer 仅分配给指定的线程，从此以后该 buffer 不再被其他线程访问。<ul>
<li>Buffer 队列的数量 ≥ 消费者线程数量：每个消费线程按照顺序绑定一个或者多个 Buffer 队列。</li>
<li>Buffer 队列的数量 ＜ 消费者线程数量：此时一个 Buffer 队列可能对应多个消费者线程，解决线程安全的方式是将 Buffer 队列按照消费者线程数量等比划分，每个消费者线程对应一个划分后的空间。</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-06-01_08-52-47.png" class="" title="This is 1-th image.">
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-06-01_08-53-05.png" class="" title="This is 1-th image.">
<h1 id="3-Skywalking-追踪模型"><a href="#3-Skywalking-追踪模型" class="headerlink" title="3. Skywalking 追踪模型"></a>3. Skywalking 追踪模型</h1><h2 id="3-1-追踪模型介绍"><a href="#3-1-追踪模型介绍" class="headerlink" title="3.1 追踪模型介绍"></a>3.1 追踪模型介绍</h2><img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-06-01_10-33-13.png" class="" title="This is 1-th image.">
<p><span style="color:#FF0000; font-weight:bold;">整个追踪树的 TraceId 是什么？</span></p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-06-01_10-46-21.png" class="" title="This is 1-th image.">
<h2 id="3-2-Skywalking-的追踪模型"><a href="#3-2-Skywalking-的追踪模型" class="headerlink" title="3.2 Skywalking 的追踪模型"></a>3.2 Skywalking 的追踪模型</h2><p><strong>Segment</strong><br>一个 Segment 是 Trace 在一个 <strong>进程内单次访问</strong> 的所有 Span 集合。如果是多个线程血统生产成一个 Trace ，它们也只会共同创建一个 Segment，而不是多个。在追踪树形图中，使用不同的颜色来区分不同的 Segment 。<br>比如一个请求经过了 前置系统、网管、后端应用。那么会有三个 Segment ，每个 Segment 中包含了多个 Span （比如调用 redis 的 Span ，调用 MySQL 的 Span 、微服务调用的 Span 等）。</p>
<p>Skywalking 中没有 RootSpan 的概念，因为模型支持多个入口，因此没有唯一的 Root 节点。</p>
<p>使用 Segment 的好处：同一个实例将所有的 Span 进行组合后批量发送，效率会大大提升；其次，使用 Segment 可以清晰观察服务之间的调用关系。</p>
<h2 id="3-3-Skywalking-探针上下文传播协议"><a href="#3-3-Skywalking-探针上下文传播协议" class="headerlink" title="3.3 Skywalking 探针上下文传播协议"></a>3.3 Skywalking 探针上下文传播协议</h2><p>传播上下文是一个键值对， key 为 sw6 ，value 是由多个 <strong>字段</strong> 用 ‘-’ 连接而成的字符串。形如： “1-traceId-segmentId-3-5-2-ipport”。<br>在传输时，将该键值对放入 HTTP 的 Header 中进行传递。</p>
<p>字段说明：</p>
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-06-01_17-12-32.png" class="" title="This is 1-th image.">
<img src="/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/Snipaste_2022-06-01_17-12-56.png" class="" title="This is 1-th image.">
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://jeckfs.gitee.io/JeckFS">YFS</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://jeckfs.gitee.io/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/">http://jeckfs.gitee.io/JeckFS/2022/05/28/Skywalking%E6%A2%B3%E7%90%86/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://jeckfs.gitee.io/JeckFS" target="_blank">JeckFS</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/JeckFS/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></div><div class="post_share"><div class="social-share" data-image="https://img0.baidu.com/it/u=4226681601,4255880919&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=641&amp;h=361" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/JeckFS/2022/06/07/leetcode638-%E5%A4%A7%E7%A4%BC%E5%8C%85/"><img class="prev-cover" src="https://img2.baidu.com/it/u=3747114911,414713113&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=882&amp;h=500" onerror="onerror=null;src='/JeckFS/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">leetcode638-大礼包</div></div></a></div><div class="next-post pull-right"><a href="/JeckFS/2022/05/24/MyPro/"><img class="next-cover" src="https://img2.baidu.com/it/u=341242123,757592285&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1280&amp;h=800" onerror="onerror=null;src='/JeckFS/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MyPro</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/JeckFS/2021/09/04/APM-skywalking/" title="APM-skywalking"><img class="cover" src="https://img1.baidu.com/it/u=2598981474,2305186611&fm=253&fmt=auto&app=138&f=JPEG?w=800&h=500" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-04</div><div class="title">APM-skywalking</div></div></a></div><div><a href="/JeckFS/2021/09/15/APM-skywalking-%E4%B9%A6%E7%B1%8D%E7%9B%AE%E5%BD%95%E7%AC%94%E8%AE%B0/" title="APM-skywalking-书籍目录笔记"><img class="cover" src="https://img0.baidu.com/it/u=297071526,3870034878&fm=253&fmt=auto&app=138&f=JPEG?w=499&h=332" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-15</div><div class="title">APM-skywalking-书籍目录笔记</div></div></a></div><div><a href="/JeckFS/2021/07/22/SpringCloud%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/" title="SpringCloud核心组件"><img class="cover" src="https://img1.baidu.com/it/u=2709423071,2700494803&fm=253&fmt=auto&app=120&f=JPEG?w=500&h=281" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-22</div><div class="title">SpringCloud核心组件</div></div></a></div><div><a href="/JeckFS/2021/09/20/apollo%E4%B8%8D%E5%90%8C%E4%B8%BB%E6%9C%BA%E5%90%8C%E6%97%B6%E6%90%AD%E5%BB%BADEV-UAT-PRO%E7%8E%AF%E5%A2%83/" title="apollo不同主机同时搭建DEV,UAT,PRO环境"><img class="cover" src="https://img1.baidu.com/it/u=2231100910,1753720113&fm=253&fmt=auto&app=138&f=JPEG?w=889&h=500" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-20</div><div class="title">apollo不同主机同时搭建DEV,UAT,PRO环境</div></div></a></div><div><a href="/JeckFS/2021/09/14/skywalking-%E5%85%B6%E4%BB%96%E4%B8%BB%E6%9C%BA%E6%8E%A5%E5%85%A5skywalking%E6%97%A5%E5%BF%97/" title="skywalking-其他主机接入skywalking日志"><img class="cover" src="https://img1.baidu.com/it/u=2709423071,2700494803&fm=253&fmt=auto&app=120&f=JPEG?w=500&h=281" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-14</div><div class="title">skywalking-其他主机接入skywalking日志</div></div></a></div><div><a href="/JeckFS/2022/06/13/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%B8%AD%E7%9A%84%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/" title="微服务架构中的进程通信"><img class="cover" src="https://img2.baidu.com/it/u=1787475710,2159333383&fm=253&fmt=auto&app=120&f=JPEG?w=1280&h=800" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-13</div><div class="title">微服务架构中的进程通信</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/JeckFS/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">YFS</div><div class="author-info__description">快乐每一天</div></div><div class="card-info-data site-data is-center"><a href="/JeckFS/archives/"><div class="headline">文章</div><div class="length-num">234</div></a><a href="/JeckFS/tags/"><div class="headline">标签</div><div class="length-num">67</div></a><a href="/JeckFS/categories/"><div class="headline">分类</div><div class="length-num">63</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Skywalking-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">1. Skywalking 整体架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%8E%A2%E9%92%88"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 探针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Skywalking-%E5%90%8E%E7%AB%AF-%E4%B8%8E-UI"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 Skywalking 后端 与 UI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%98%9F%E5%88%97%E5%86%85%E6%A0%B8"><span class="toc-number">2.</span> <span class="toc-text">2.轻量级队列内核</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Skywalking-%E8%BF%BD%E8%B8%AA%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">3. Skywalking 追踪模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E8%BF%BD%E8%B8%AA%E6%A8%A1%E5%9E%8B%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 追踪模型介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Skywalking-%E7%9A%84%E8%BF%BD%E8%B8%AA%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Skywalking 的追踪模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Skywalking-%E6%8E%A2%E9%92%88%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BC%A0%E6%92%AD%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Skywalking 探针上下文传播协议</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/JeckFS/2022/10/06/%E9%A9%BE%E8%80%83-%E7%A7%91%E7%9B%AE%E4%B8%80/" title="驾考-科目一"><img src="https://img1.baidu.com/it/u=2322041376,2548191196&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=889&amp;h=500" onerror="this.onerror=null;this.src='/JeckFS/img/404.jpg'" alt="驾考-科目一"/></a><div class="content"><a class="title" href="/JeckFS/2022/10/06/%E9%A9%BE%E8%80%83-%E7%A7%91%E7%9B%AE%E4%B8%80/" title="驾考-科目一">驾考-科目一</a><time datetime="2022-10-06T12:14:56.000Z" title="发表于 2022-10-06 20:14:56">2022-10-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/JeckFS/2022/09/27/%E5%85%85%E8%A1%80%E6%A8%A1%E5%9E%8B%E4%B8%8E%E8%B4%AB%E8%A1%80%E6%A8%A1%E5%9E%8B/" title="充血模型与贫血模型"><img src="https://img2.baidu.com/it/u=1787475710,2159333383&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1280&amp;h=800" onerror="this.onerror=null;this.src='/JeckFS/img/404.jpg'" alt="充血模型与贫血模型"/></a><div class="content"><a class="title" href="/JeckFS/2022/09/27/%E5%85%85%E8%A1%80%E6%A8%A1%E5%9E%8B%E4%B8%8E%E8%B4%AB%E8%A1%80%E6%A8%A1%E5%9E%8B/" title="充血模型与贫血模型">充血模型与贫血模型</a><time datetime="2022-09-27T05:59:41.000Z" title="发表于 2022-09-27 13:59:41">2022-09-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/JeckFS/2022/09/16/vim%E6%89%8B%E5%86%8C/" title="vim手册"><img src="https://img1.baidu.com/it/u=2231100910,1753720113&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=889&amp;h=500" onerror="this.onerror=null;this.src='/JeckFS/img/404.jpg'" alt="vim手册"/></a><div class="content"><a class="title" href="/JeckFS/2022/09/16/vim%E6%89%8B%E5%86%8C/" title="vim手册">vim手册</a><time datetime="2022-09-16T01:57:05.000Z" title="发表于 2022-09-16 09:57:05">2022-09-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/JeckFS/2022/09/15/openGauss-%E7%AE%A1%E7%90%86%E5%8F%8A%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" title="openGauss-管理及开发工具"><img src="https://img2.baidu.com/it/u=3747114911,414713113&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=882&amp;h=500" onerror="this.onerror=null;this.src='/JeckFS/img/404.jpg'" alt="openGauss-管理及开发工具"/></a><div class="content"><a class="title" href="/JeckFS/2022/09/15/openGauss-%E7%AE%A1%E7%90%86%E5%8F%8A%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" title="openGauss-管理及开发工具">openGauss-管理及开发工具</a><time datetime="2022-09-15T08:35:23.000Z" title="发表于 2022-09-15 16:35:23">2022-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/JeckFS/2022/09/14/diff%E8%AF%A6%E8%A7%A3/" title="diff详解"><img src="https://img2.baidu.com/it/u=2566230917,2808117782&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=889&amp;h=500" onerror="this.onerror=null;this.src='/JeckFS/img/404.jpg'" alt="diff详解"/></a><div class="content"><a class="title" href="/JeckFS/2022/09/14/diff%E8%AF%A6%E8%A7%A3/" title="diff详解">diff详解</a><time datetime="2022-09-14T09:56:54.000Z" title="发表于 2022-09-14 17:56:54">2022-09-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By YFS</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/JeckFS/js/utils.js"></script><script src="/JeckFS/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/JeckFS/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>